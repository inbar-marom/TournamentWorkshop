@page "/bots"
@model TournamentEngine.Dashboard.Pages.BotsPageModel
@{
    ViewData["Title"] = "Bot Submissions";
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-6">
            <h1>Bot Submission Dashboard</h1>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btnList">List View</button>
                <button type="button" class="btn btn-sm btn-outline-primary" id="btnRefresh">Refresh</button>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <small class="text-muted">Total Bots</small>
                    <h3 id="statsTotal">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <small class="text-muted">Valid ✅</small>
                    <h3 id="statsValid" class="text-success">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <small class="text-muted">Invalid ❌</small>
                    <h3 id="statsInvalid" class="text-danger">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <small class="text-muted">Pending ⏳</small>
                    <h3 id="statsPending" class="text-warning">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Search & Filter -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by team name...">
        </div>
        <div class="col-md-3">
            <select id="filterStatus" class="form-select">
                <option value="">All Statuses</option>
                <option value="Valid">Valid ✅</option>
                <option value="Invalid">Invalid ❌</option>
                <option value="Pending">Pending ⏳</option>
            </select>
        </div>
        <div class="col-md-3">
            <select id="sortBy" class="form-select">
                <option value="submissiontime">Newest Submissions</option>
                <option value="teamname">Team Name (A-Z)</option>
                <option value="status">Status</option>
            </select>
        </div>
    </div>

    <!-- Bots Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Team Name</th>
                        <th>Submission Time</th>
                        <th>Status</th>
                        <th>Files</th>
                        <th>Size</th>
                        <th>Version</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="botsTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            Loading bots...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bot Details: <span id="detailTeamName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <small class="text-muted">Status</small>
                            <p><span id="detailStatus" class="badge"></span></p>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">Submission Time</small>
                            <p id="detailSubmissionTime"></p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <small class="text-muted">Files</small>
                            <p id="detailFileCount"></p>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">Total Size</small>
                            <p id="detailSize"></p>
                        </div>
                    </div>

                    <h6>Files</h6>
                    <ul id="detailFilesList" class="list-group mb-3">
                    </ul>

                    <div id="detailErrors" class="alert alert-danger d-none" role="alert">
                        <strong>Compilation Errors:</strong>
                        <pre id="detailErrorsText"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="btnValidate">Re-Validate</button>
                    <button type="button" class="btn btn-danger" id="btnDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --primary-color: #0d6efd;
        --success-color: #198754;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
    }

    body {
        background-color: #f8f9fa;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: none;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    .badge {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }

    .badge.valid {
        background-color: var(--success-color);
    }

    .badge.invalid {
        background-color: var(--danger-color);
    }

    .badge.pending {
        background-color: var(--warning-color);
        color: #000;
    }

    .modal-header {
        border-bottom: 1px solid #dee2e6;
    }

    .spinner-border-sm {
        width: 1.5rem;
        height: 1.5rem;
        border-width: 0.25em;
    }
</style>

<script>
let detailModal;
let currentBotTeamName;

document.addEventListener('DOMContentLoaded', function() {
    detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
    loadBots();
    
    // Event listeners
    document.getElementById('btnRefresh').addEventListener('click', loadBots);
    document.getElementById('searchInput').addEventListener('input', filterBots);
    document.getElementById('filterStatus').addEventListener('change', filterBots);
    document.getElementById('sortBy').addEventListener('change', sortBots);
    document.getElementById('btnValidate').addEventListener('click', validateBot);
    document.getElementById('btnDelete').addEventListener('click', deleteBot);
});

async function loadBots() {
    try {
        const response = await fetch('/api/dashboard/bots/');
        const result = await response.json();
        
        if (result.success) {
            displayBots(result.data);
            updateStats(result.data);
        }
    } catch (error) {
        console.error('Error loading bots:', error);
        showError('Failed to load bots');
    }
}

function displayBots(bots) {
    const tbody = document.getElementById('botsTableBody');
    
    if (bots.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No bots found</td></tr>';
        return;
    }

    tbody.innerHTML = bots.map(bot => `
        <tr style="cursor: pointer;" onclick="showBotDetail('${bot.teamName}')">
            <td><strong>${escapeHtml(bot.teamName)}</strong></td>
            <td><small>${new Date(bot.submissionTime).toLocaleString()}</small></td>
            <td>${getStatusBadge(bot.status)}</td>
            <td>${bot.fileCount}</td>
            <td>${formatBytes(bot.totalSizeBytes)}</td>
            <td>v${bot.version}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); showBotDetail('${bot.teamName}')">
                    View
                </button>
            </td>
        </tr>
    `).join('');
}

function updateStats(bots) {
    document.getElementById('statsTotal').textContent = bots.length;
    document.getElementById('statsValid').textContent = bots.filter(b => b.status === 'Valid').length;
    document.getElementById('statsInvalid').textContent = bots.filter(b => b.status === 'Invalid').length;
    document.getElementById('statsPending').textContent = bots.filter(b => b.status !== 'Valid' && b.status !== 'Invalid').length;
}

function getStatusBadge(status) {
    const statusLower = status.toLowerCase();
    const icons = {
        'valid': '✅',
        'invalid': '❌',
        'pending': '⏳'
    };
    const icon = icons[statusLower] || '❓';
    return `<span class="badge ${statusLower}">${icon} ${status}</span>`;
}

async function showBotDetail(teamName) {
    try {
        const response = await fetch(`/api/dashboard/bots/${encodeURIComponent(teamName)}`);
        const result = await response.json();
        
        if (result.success) {
            currentBotTeamName = teamName;
            populateDetailModal(result.data);
            detailModal.show();
        }
    } catch (error) {
        console.error('Error loading bot details:', error);
        showError('Failed to load bot details');
    }
}

function populateDetailModal(bot) {
    document.getElementById('detailTeamName').textContent = bot.teamName;
    document.getElementById('detailStatus').innerHTML = getStatusBadge(bot.status);
    document.getElementById('detailStatus').className = '';
    document.getElementById('detailSubmissionTime').textContent = new Date(bot.submissionTime).toLocaleString();
    document.getElementById('detailFileCount').textContent = bot.fileCount;
    document.getElementById('detailSize').textContent = formatBytes(bot.totalSizeBytes);
    
    const filesList = document.getElementById('detailFilesList');
    filesList.innerHTML = (bot.fileNames || []).map(file => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>${escapeHtml(file)}</span>
            <small class="text-muted">.cs</small>
        </li>
    `).join('');

    const errorsDiv = document.getElementById('detailErrors');
    if (bot.compilationError) {
        errorsDiv.classList.remove('d-none');
        document.getElementById('detailErrorsText').textContent = bot.compilationError;
    } else {
        errorsDiv.classList.add('d-none');
    }
}

async function validateBot() {
    try {
        const response = await fetch(`/api/dashboard/bots/${encodeURIComponent(currentBotTeamName)}/validate`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Bot validation triggered successfully');
            detailModal.hide();
            loadBots();
        }
    } catch (error) {
        console.error('Error validating bot:', error);
        showError('Failed to validate bot');
    }
}

async function deleteBot() {
    if (!confirm('Are you sure you want to delete this bot?')) return;
    
    try {
        const response = await fetch(`/api/bots/${encodeURIComponent(currentBotTeamName)}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showSuccess('Bot deleted successfully');
            detailModal.hide();
            loadBots();
        }
    } catch (error) {
        console.error('Error deleting bot:', error);
        showError('Failed to delete bot');
    }
}

function filterBots() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filterStatus = document.getElementById('filterStatus').value;
    const rows = document.querySelectorAll('#botsTableBody tr');
    
    rows.forEach(row => {
        const teamName = row.querySelector('td')?.textContent.toLowerCase() || '';
        const status = row.querySelector('.badge')?.textContent || '';
        
        const matchSearch = teamName.includes(searchTerm);
        const matchStatus = !filterStatus || status.includes(filterStatus);
        
        row.style.display = (matchSearch && matchStatus) ? '' : 'none';
    });
}

function sortBots() {
    // Simple client-side sort - in production, would reload from API
    loadBots();
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row').nextSibling);
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row').nextSibling);
    setTimeout(() => alert.remove(), 3000);
}

// SignalR real-time updates
const connection = new signalR.HubConnectionBuilder()
    .withUrl('/tournamentHub')
    .withAutomaticReconnect()
    .build();

connection.on('BotSubmitted', (bot) => {
    console.log('Bot submitted:', bot);
    loadBots();
});

connection.on('BotValidated', (bot) => {
    console.log('Bot validated:', bot);
    loadBots();
});

connection.on('BotDeleted', (teamName) => {
    console.log('Bot deleted:', teamName);
    loadBots();
});

connection.on('BotListUpdated', (bots) => {
    console.log('Bot list updated');
    loadBots();
});

connection.on('ValidationProgress', (payload) => {
    console.log('Validation progress:', payload);
});

connection.start().catch(err => console.error('SignalR connection error:', err));
</script>
